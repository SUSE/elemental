##########################################################
#                        WARNING                         #
#                                                        #
#              This file is managed in GIT!              #
# Any changes via the openQA WebUI could be overwritten! #
#                                                        #
# Job Group: Containers / Unified Core                   #
#                                                        #
# https://github.com/suse/elemental                      #
# Maintainers: Unified Core team <unified-core@suse.com> #
##########################################################

---

.default_products: &default_products
  distri: sle

.common_test_settings: &common_test_settings
  HDDSIZEGB: '30'
  K8S: rke2
  QEMUCPUS: '4'
  QEMURAM: '4096'
  TEST_PASSWORD: Elemental@R00t
  YAML_SCHEDULE: schedule/elemental3/os_image.yaml

.common_microos_boot_settings: &common_microos_boot_settings
  BOOTFROM: disk
  CONTAINER_RUNTIMES: podman
  DESKTOP: textmode
  EXCLUDE_MODULES: suseconnect_scc
  HDD_1: 'SL-Micro.%ARCH%-6.2-Default-Updated.qcow2'
  HDDSIZEGB: '30'
  KEEP_GRUB_TIMEOUT: '0'
  VIDEOMODE: text

.generate_settings: &generate_settings
  <<: *common_microos_boot_settings
  IMG_NAME: 'elemental-%BUILD%-%ARCH%-%TESTED_CMD%'
  K8S: rke2
  KERNEL_CMD_LINE: 'console=ttyS0'
  QEMURAM: '2048'
  TEST_PASSWORD: Elemental@R00t
  YAML_SCHEDULE: schedule/elemental3/generate.yaml

.test_raw_settings: &test_raw_settings
  <<: *common_test_settings
  HDD_1: 'elemental-%BUILD%-%ARCH%-%TESTED_CMD%.qcow2'
  IMAGE_TYPE: raw
  TEST_TYPE: test_image

.test_iso_settings: &test_iso_settings
  <<: *common_test_settings
  BOOTFROM: disk
  IMAGE_TYPE: iso
  ISO: 'elemental-%BUILD%-%ARCH%-%TESTED_CMD%.iso'
  TEST_TYPE: test_iso

.k8s_test_settings: &k8s_test_settings
  EXPECTED_NM_CONNECTIVITY: none
  NICTYPE: tap
  NODES_LIST: node01
  TESTS_TO_RUN: validatecluster,deployrancher
  TEST_TYPE: k8s_validation

.node_k8s_validation_settings: &node_k8s_validation_settings
  <<: *common_test_settings
  <<: *k8s_test_settings
  HDD_1: 'elemental-%BUILD%-%ARCH%-%TESTED_CMD%.qcow2'
  PARALLEL_WITH: master

.master_k8s_validation_settings: &master_k8s_validation_settings
  <<: *common_microos_boot_settings
  <<: *k8s_test_settings
  CERTMANAGER_VERSION: v1.19.1
  +DISTRI: sle-micro
  +HDD_1: 'openSUSE-MicroOS.%ARCH%-Updated.qcow2'
  HOSTNAME: master
  K8S: rke2
  QEMURAM: '4096'
  RANCHER_VERSION: v2.13.2
  TEST_FRAMEWORK_REPO: https://github.com/ldevulder/distros-test-framework@fix-support-uc-os-image
  YAML_SCHEDULE: schedule/elemental3/master.yaml

defaults:
  aarch64:
    machine: aarch64-virtio
    priority: 50
  x86_64:
    machine: uefi-virtio-vga
    priority: 50
    settings:
      QEMUCPU: host

products:
  sle-unifiedcore-image-16.0-aarch64:
    <<: *default_products
    flavor: UnifiedCore-Image
    version : '16.0'
  sle-unifiedcore-image-16.0-x86_64:
    <<: *default_products
    flavor: UnifiedCore-Image
    version : '16.0'

scenarios:
  aarch64:
    sle-unifiedcore-image-16.0-aarch64:
      - generate_with_install:
          testsuite: null
          settings:
            <<: *generate_settings
            TESTED_CMD: install
      - generate_iso_with_customize:
          testsuite: null
          settings:
            <<: *generate_settings
            IMAGE_TYPE: iso
            TESTED_CMD: customize
      - generate_raw_with_customize:
          testsuite: null
          settings:
            <<: *generate_settings
            IMAGE_TYPE: raw
            TESTED_CMD: customize
      - generate_with_build_installer_iso:
          testsuite: null
          settings:
            <<: *generate_settings
            ISO_CMD_LINE: 'console=ttyS0 enforcing=0'
            TESTED_CMD: build_installer_iso
      - test_iso:
          testsuite: null
          settings:
            <<: *test_iso_settings
            TESTED_CMD: build_installer_iso
            START_AFTER_TEST: generate_with_%TESTED_CMD%
      - test_release_manifest_iso:
          testsuite: null
          settings:
            <<: *test_iso_settings
            TESTED_CMD: customize
            START_AFTER_TEST: generate_iso_with_%TESTED_CMD%
      - test_release_manifest_raw:
          testsuite: null
          settings:
            <<: *test_raw_settings
            TESTED_CMD: customize
            START_AFTER_TEST: generate_raw_with_%TESTED_CMD%
      - master:
          testsuite: null
          settings:
            <<: *master_k8s_validation_settings
            TESTED_CMD: customize
            START_AFTER_TEST: generate_raw_with_%TESTED_CMD%
      - node01:
          testsuite: null
          settings:
            <<: *node_k8s_validation_settings
            HOSTNAME: node01
            TESTED_CMD: customize
  x86_64:
    sle-unifiedcore-image-16.0-x86_64:
      - generate_with_install:
          machine: 64bit
          testsuite: null
          settings:
            <<: *generate_settings
            TESTED_CMD: install
      - generate_iso_with_customize:
          machine: 64bit
          testsuite: null
          settings:
            <<: *generate_settings
            IMAGE_TYPE: iso
            TESTED_CMD: customize
      - generate_raw_with_customize:
          machine: 64bit
          testsuite: null
          settings:
            <<: *generate_settings
            IMAGE_TYPE: raw
            TESTED_CMD: customize
      - generate_with_build_installer_iso:
          machine: 64bit
          testsuite: null
          settings:
            <<: *generate_settings
            ISO_CMD_LINE: 'console=ttyS0 enforcing=0'
            TESTED_CMD: build_installer_iso
      - test_iso:
          testsuite: null
          settings:
            <<: *test_iso_settings
            TESTED_CMD: build_installer_iso
            START_AFTER_TEST: generate_with_%TESTED_CMD%@64bit
      - test_release_manifest_iso:
          testsuite: null
          settings:
            <<: *test_iso_settings
            TESTED_CMD: customize
            START_AFTER_TEST: generate_iso_with_%TESTED_CMD%@64bit
      - test_release_manifest_raw:
          testsuite: null
          settings:
            <<: *test_raw_settings
            TESTED_CMD: customize
            START_AFTER_TEST: generate_raw_with_%TESTED_CMD%@64bit
      - master:
          testsuite: null
          settings:
            <<: *master_k8s_validation_settings
            TESTED_CMD: customize
            START_AFTER_TEST: generate_raw_with_%TESTED_CMD%@64bit
      - node01:
          testsuite: null
          settings:
            <<: *node_k8s_validation_settings
            HOSTNAME: node01
            TESTED_CMD: customize
